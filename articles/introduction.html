<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview of the SPIAT package • SPIAT</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Overview of the SPIAT package">
<meta property="og:description" content="SPIAT">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SPIAT</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Overview of the SPIAT package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cancer-evolution/SPIAT/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="introduction_files/htmlwidgets-1.5.1/htmlwidgets.js"></script><script src="introduction_files/plotly-binding-4.9.2.1/plotly.js"></script><script src="introduction_files/typedarray-0.1/typedarray.min.js"></script><script src="introduction_files/jquery-1.11.3/jquery.min.js"></script><link href="introduction_files/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet">
<script src="introduction_files/crosstalk-1.1.0.1/js/crosstalk.min.js"></script><link href="introduction_files/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet">
<script src="introduction_files/plotly-main-1.52.2/plotly-latest.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview of the SPIAT package</h1>
                        <h4 class="author">Anna Trigos, Tom Yang, Volkan Ozkoban</h4>
            
            <h4 class="date">20 August 2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cancer-evolution/SPIAT/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>SPIAT (<strong>Sp</strong>atial <strong>I</strong>mage <strong>A</strong>nalysis of <strong>T</strong>issues) is an R package with a suite of data processing, quality control, visualization, data handling and data analysis tools. SPIAT includes our novel algorithms for the identification of cell clusters, cell margins and cell gradients, the calculation of neighbourhood proportions, and algorithms for the prediction of cell phenotypes. SPIAT also includes speedy implementations of the calculation of cell distances and detection of cell communities. An overview of the functions available is shown in the figure below.</p>
<p>This version of SPIAT is directly compatible with Opal multiplex immunohistochemistry images analysed through the HALO and InForm analysis software, but its intuitive implementation allows use with a diversity of platforms.</p>
<p>The new Opal multiplex immunohistochemistry staining protocol allows the use of 6-8 markers simultaneously on a single slide followed by imaging on the Perkin Elmer Vectra quantitative imaging system. It has gained significant popularity due to its applicability to formalin fixed paraffin embedded tissue sections, allowing the examination of samples taken in a clinical setting. The imaging system records the fluorescence emission for each marker, and each cell is assigned an X,Y coordinate of its location in the tissue, effectively providing single-cell resolution. The fluorescence emission maps of individual markers are then combined to yield the location and phenotype of cells, along with marker intensity.</p>
<p><img width="600" alt="overview" src="https://www.biorxiv.org/content/biorxiv/early/2020/05/30/2020.05.28.122614/F1.large.jpg"></p>
</div>
<div id="setting-up-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#setting-up-the-data" class="anchor"></a>Setting up the data</h1>
<p>First we load the SPIAT library.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># load library</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">SPIAT</span>)</pre></body></html></div>
<p>For this tutorial we will use data that’s already formatted for SPIAT. <code>formatted_image</code> This is <em>SingleCellExperiment</em> format where the count assay stores the expression level of every marker (rows) for every cell (columns), and cell phenotype, x and y coordinates, other properties (Cell Size, Nucleus Size, Nucleus Compactness, Nucleus Axis Ratio, Cell Axis Ratio ) are stored under colData.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"formatted_image"</span>)</pre></body></html></div>
<p>The steps to format data for SPIAT are shown in the code below. It requires 3 things:</p>
<ul>
<li>path to the raw InForm or HALO data file</li>
<li>names of the markers used in the OPAL staining</li>
<li>names of the intensity columns of interest</li>
</ul>
<p>We would use <code>format_image_to_sce</code> to format the data for SPIAT as shown in the commented out code below. <code>format_image_to_sce</code> creates a SingleCellExperiment object.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"># raw_inform_data &lt;- "S6_[49209,17530]_cell_seg_data.txt"

# markers &lt;- c("DAPI","CD3","PDL1","CD4","CD8","AMACR")

# intensity_columns_interest &lt;- c(
  "Nucleus DAPI (DAPI) Mean (Normalized Counts, Total Weighting)",
  "Cytoplasm CD3 (Opal 520) Mean (Normalized Counts, Total Weighting)", 
  "Membrane PDL-1 (Opal 540) Mean (Normalized Counts, Total Weighting)",
  "Cytoplasm CD4 (Opal 620) Mean (Normalized Counts, Total Weighting)",
  "Cytoplasm CD8 (Opal 650) Mean (Normalized Counts, Total Weighting)", 
  "Cytoplasm AMACR (Opal 690) Mean (Normalized Counts, Total Weighting)"
  )

# formatted_image &lt;- format_image_to_sce(
#                           format="INFORM",
#                           image=raw_inform_data,
#                           markers=markers,
#                           intensity_columns_interest=intensity_columns_interest,
#                           dye_columns_interest=NULL
)</pre></body></html></div>
<p>In the case of large images, or images where there are two independent tissue sections, it is recommended to split images into sections defined by the user. This can be performed with <code>image_splitter</code>. It can also plot the different combinations of markers within the image segments.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">split_image</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/image_splitter.html">image_splitter</a></span>(<span class="no">formatted_image</span>, <span class="kw">number_of_splits</span><span class="kw">=</span><span class="fl">3</span>, <span class="kw">plot</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<p>We can check what phenotypes are present in the image data with <code>print_phenotypes</code>.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/print_phenotypes.html">print_phenotypes</a></span>(<span class="no">formatted_image</span>)</pre></body></html></div>
<pre><code>## [1] "AMACR"   "CD3,CD4" "CD3,CD8" "PDL1"</code></pre>
<p>These phenotypes are determined from individual markers like AMACR ro combinations of markers like CD3 and CD4. The above markers can be interpreted as follows:</p>
<p>AMACR = prostate cancer cells<br>
CD3,CD4 = helper T cells<br>
CD3,CD8 = cytotoxic T cells<br>
PDL1 = immune checkpoint</p>
<p>So AMACR identifies which cells in the image are prostate cancer cells. CD3,CD4 and CD3,CD8 which types of T cells (immune cells) are present, and PDL1 is used to help determine if the cancer may benefit from immunotherapy treatment.</p>
</div>
<div id="quality-control-of-images" class="section level1">
<h1 class="hasAnchor">
<a href="#quality-control-of-images" class="anchor"></a>Quality control of images</h1>
<p>Since cell phenotypes can be defined by combination of markers, low cell segmentation quality, antibody ‘bleeding’ from one cell to another or inadequate marker thresholding, can lead to the assignment of erroneous cell phenotypes. Cells might be identified as being positive for a biologically unfeasible combination of markers (for example, cells positive for a tumour cell marker such as AMACR and an immune cell marker, such as CD3). Therefore, SPIAT allows the user to manually input which phenotypes they would like to keep or exclude with <code>select_phenotypes</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">data_subset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/select_phenotypes.html">select_phenotypes</a></span>(<span class="no">formatted_image</span>, <span class="kw">keep</span><span class="kw">=</span><span class="fl">TRUE</span>,
                                     <span class="kw">phenotypes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AMACR"</span>,
                                                    <span class="st">"CD3,CD8"</span>,
                                                    <span class="st">"PDL1"</span>))
<span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/print_phenotypes.html">print_phenotypes</a></span>(<span class="no">data_subset</span>)</pre></body></html></div>
<pre><code>## [1] "AMACR"   "CD3,CD8" "PDL1"</code></pre>
<p>Alternatively, we also implemented a shuffling strategy to determine how likely it is to obtain a particular combination of markers by chance with <code>marker_permutation</code>. Here, we create a null distribution by permuting the marker labels of cells, and calculate the empirical p-value of whether an image is enriched or depleted in a particular combination of markers. This is meant to provide guidance to the users of which combination is likely to occur by chance (e.g. because there are high numbers of cells positive for particular marker), but it is not absolute, and users are highly encouraged to review the results.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">sig</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/marker_permutation.html">marker_permutation</a></span>(<span class="no">formatted_image</span>, <span class="kw">num_iter</span> <span class="kw">=</span> <span class="fl">100</span>)</pre></body></html></div>
<p>We will work with all the original phenotypes present in <code>formatted_image</code> here.</p>
<div id="boxplots-of-positive-vs-negative-cells" class="section level2">
<h2 class="hasAnchor">
<a href="#boxplots-of-positive-vs-negative-cells" class="anchor"></a>Boxplots of positive vs negative cells</h2>
<p>Cells positive for a marker should have higher levels of the marker. Since HALO and InForm use machine learning to determine positive cells, and not a strict threshold, some positive cells will have low marker intensity, and vice versa. However, an unclear separation of marker intensities between positive and negative cells would suggest incorrect phenotyping or unreliable phenotyping due to background noise. We can use <code>marker_expression_boxplot</code> to produce a boxplot for cells phenotyped as being positive or negative for a marker.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/marker_expression_boxplot.html">marker_expression_boxplot</a></span>(<span class="no">formatted_image</span>, <span class="st">"CD3"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div id="cell-proportionspercentages" class="section level2">
<h2 class="hasAnchor">
<a href="#cell-proportionspercentages" class="anchor"></a>Cell proportions/percentages</h2>
<p>Calculate the number and proportion of each cell phenotype in image.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">p_cells</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/calculate_cell_proportions.html">calculate_cell_proportions</a></span>(<span class="kw">sce_object</span> <span class="kw">=</span> <span class="no">formatted_image</span>)
<span class="no">p_cells</span></pre></body></html></div>
<pre><code>##   Cell_type Number_of_cells Proportion Percentage
## 1     AMACR            4446 0.87159381  87.159381
## 2   CD3,CD4             513 0.10056852  10.056852
## 3   CD3,CD8             138 0.02705352   2.705352
## 4      PDL1               4 0.00078416   0.078416</code></pre>
<p>Plot cells proportions as barplots</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_cell_percentages.html">plot_cell_percentages</a></span>(<span class="no">p_cells</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
</div>
<div id="visualizing-tissues" class="section level1">
<h1 class="hasAnchor">
<a href="#visualizing-tissues" class="anchor"></a>Visualizing tissues</h1>
<div id="categorical-dot-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#categorical-dot-plot" class="anchor"></a>Categorical dot plot</h2>
<p>We can generate a dot plot that summarizes all markers and cell types with <code>plot_cell_categories</code>. Each dot corresponds to a cell and cells are coloured by phenotype. The user can choose the colours for the phenotypes. Any phenotypes present in the data but not in the phenotypes of interest will be put in the category “OTHER” and coloured lightgrey.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">phenotypes_of_interest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AMACR"</span>, <span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span>)
<span class="no">colour_vector</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkgrey"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>)
<span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_cell_categories.html">plot_cell_categories</a></span>(<span class="no">formatted_image</span>, <span class="no">phenotypes_of_interest</span>, <span class="no">colour_vector</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div id="scatter-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#scatter-plots" class="anchor"></a>Scatter plots</h2>
<p>The intensity of each marker can be visualized individually, which can be used to check for an uneven staining or high background intensity. <code>plot_cell_marker_levels</code> produces a scatter plot of the expression of every marker in each cell. Cells that were not phenotyped as being positive for the particular marker are excluded.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_cell_marker_levels.html">plot_cell_marker_levels</a></span>(<span class="no">formatted_image</span>, <span class="st">"CD3"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div id="heatmaps" class="section level2">
<h2 class="hasAnchor">
<a href="#heatmaps" class="anchor"></a>Heatmaps</h2>
<p>For large images, there is also the option of ‘blurring’ the image, where the image is split into multiple small areas, and marker intensities are averaged within each. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_marker_level_heatmap.html">plot_marker_level_heatmap</a></span>(<span class="no">formatted_image</span>, <span class="kw">num_splits</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="st">"CD3"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div id="d-surface-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#d-surface-plot" class="anchor"></a>3D surface plot</h2>
<p>We can generate a 3D surface plot of the level of the selected marker with <code>marker_surface_plot</code>. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/marker_surface_plot.html">marker_surface_plot</a></span>(<span class="no">formatted_image</span>, <span class="kw">num_splits</span><span class="kw">=</span><span class="fl">15</span>, <span class="kw">marker</span><span class="kw">=</span><span class="st">"CD3"</span>)</pre></body></html></div>
<div id="htmlwidget-55645e135c45f9beb4a7" style="width:700px;height:432.632880098888px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-55645e135c45f9beb4a7">{"x":{"visdat":{"5ba26ab609a":["function () ","plotlyVisDat"]},"cur_data":"5ba26ab609a","attrs":{"5ba26ab609a":{"z":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"surface","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"zaxis":{"title":"mean_marker_level"}},"hovermode":"closest","showlegend":false,"legend":{"yanchor":"top","y":0.5}},"source":"A","config":{"showSendToCloud":false},"data":[{"colorbar":{"title":"mean_marker_level","ticklen":2,"len":0.5,"lenmode":"fraction","y":1,"yanchor":"top"},"colorscale":[["0","rgba(68,1,84,1)"],["0.0416666666666667","rgba(70,19,97,1)"],["0.0833333333333333","rgba(72,32,111,1)"],["0.125","rgba(71,45,122,1)"],["0.166666666666667","rgba(68,58,128,1)"],["0.208333333333333","rgba(64,70,135,1)"],["0.25","rgba(60,82,138,1)"],["0.291666666666667","rgba(56,93,140,1)"],["0.333333333333333","rgba(49,104,142,1)"],["0.375","rgba(46,114,142,1)"],["0.416666666666667","rgba(42,123,142,1)"],["0.458333333333333","rgba(38,133,141,1)"],["0.5","rgba(37,144,140,1)"],["0.541666666666667","rgba(33,154,138,1)"],["0.583333333333333","rgba(39,164,133,1)"],["0.625","rgba(47,174,127,1)"],["0.666666666666667","rgba(53,183,121,1)"],["0.708333333333333","rgba(79,191,110,1)"],["0.75","rgba(98,199,98,1)"],["0.791666666666667","rgba(119,207,85,1)"],["0.833333333333333","rgba(147,214,70,1)"],["0.875","rgba(172,220,52,1)"],["0.916666666666667","rgba(199,225,42,1)"],["0.958333333333333","rgba(226,228,40,1)"],["1","rgba(253,231,37,1)"]],"showscale":true,"z":[[1.0118,0.342769230769231,0.183475,1.0615,0.485,0.541611111111111,1.55742857142857,0.743357142857143,0.237275862068966,0.189547619047619,0.274583333333333,0.622055555555556,0.55928125,0.238121951219512,0.172826086956522],[1.01144444444444,1.66675,0.28724,0.3785,0.159290909090909,0.162783783783784,1.61842857142857,1.266,0.65,2.407,0.371333333333333,0.969666666666667,0.24728125,0.181452380952381,0.255230769230769],[0.162394736842105,3.0055,0.441666666666667,0.159888888888889,0.140973684210526,0.188190476190476,0.325971428571429,1.77897142857143,3.882,0.20190625,0.216869565217391,0.271157894736842,1.2274,0.478,0],[0.149727272727273,1.09866666666667,1.01392307692308,0.153466666666667,0.149261904761905,0.863176470588235,0.201685185185185,1.05864516129032,0.57525,0.156045454545455,0.165648648648649,0.176842105263158,1.6295,1.4678,2.304],[0.13625,0.228793103448276,2.1175,0.24662962962963,0.581266666666667,1.10514285714286,0.858689655172414,3.2591875,0.348914893617021,0.141302325581395,0.135564102564103,0.1976,3.06456,3.6554,1.48333333333333],[0.141404255319149,0.168621621621622,2.024,2.0924,3.093,1.81288888888889,3.51133333333333,0.762424242424242,0.140904761904762,0.1382,0.138697674418605,0.285116279069767,5.95489473684211,5.83108,2.20833333333333],[0.127341463414634,0.141977777777778,0,0.549428571428571,0.794944444444444,0.240823529411765,0.813928571428571,0.226666666666667,0.153325,0.1642,0.160575,0.5854,7.32355172413793,5.42923076923077,3.774],[0.128837209302326,0.157388888888889,1.59,0.6354,4.2058,0.722166666666667,0.151977272727273,0.130191489361702,0.159576923076923,0.188090909090909,0.885785714285714,3.18895238095238,6.94440909090909,3.79142857142857,5.136],[0.126268292682927,0.153967741935484,3.5475,0.957333333333333,1.88133333333333,2.14575,0.277954545454545,0.130086956521739,0.147630434782609,0.169,0.228133333333333,6.23689285714286,5.22156,0,0],[0.109227272727273,0.168027027027027,1.93,2.84966666666667,2.65566666666667,0.342818181818182,0.196666666666667,0.165157894736842,0.174439024390244,0.277894736842105,1.46491176470588,4.598,2.94825,3.5988,2.7955],[0.163714285714286,0.1776,0,1.661,2.266,0.427714285714286,0.225789473684211,0.88725,2.97825,2.199,4.8884,1.42,0,5.6425,1.059],[0.15,0,0,0.195384615384615,0.191888888888889,3.3525,2.5574,5.073,1.0564,0.485972222222222,0.838666666666667,2.092,2.6595,2.96285714285714,2.49725],[0.1484,0,0,0.171333333333333,0.128935483870968,0.538,0.5018125,0.149285714285714,0.174872340425532,0.381211538461538,0.197826086956522,0.955173913043478,1.264,0.756,3.34978571428571],[0.119666666666667,0.29155,0.137,0.170478260869565,0.120348837209302,0.181222222222222,0.133634146341463,0.120204545454545,0.136270833333333,0.14345,0.240163265306122,2.02633333333333,7.17575,2.9505,3.74472],[0.13975,0.117558823529412,0.124892857142857,0.202,0.12585,0.1113125,0.106690476190476,0.111272727272727,0.147441860465116,0.1805,0.4662,2.63033333333333,2.97036363636364,4.07809523809524,0.631818181818182]],"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="d-stacked-surface-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#d-stacked-surface-plot" class="anchor"></a>3D stacked surface plot</h2>
<p>To stack the surface plots of multiple markers in a single plot we have implemented <code>marker_surface_plot_stack</code>. This shows normalized expression level of specified markers and allows the identification of co-occurring and mutually exclusive markers.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/marker_surface_plot_stack.html">marker_surface_plot_stack</a></span>(<span class="no">formatted_image</span>, <span class="kw">num_splits</span><span class="kw">=</span><span class="fl">10</span>, <span class="kw">markers</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD3"</span>, <span class="st">"AMACR"</span>))</pre></body></html></div>
<div id="htmlwidget-3330111f65d227cfffee" style="width:700px;height:432.632880098888px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-3330111f65d227cfffee">{"x":{"visdat":{"5ba29c05533":["function () ","plotlyVisDat"]},"cur_data":"5ba29c05533","attrs":{"5ba29c05533":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"z":[[0.188884750788777,0.042538175501137,0.0639597550435166,0.0439940658366759,0.239365714219316,0.0369488839789383,0.0303714686585763,0.0720560345601629,0.0539545792762385,0.0296867777313727],[0.0405149022207013,0.0984779130858437,0.0328609841478996,0.0249033443946144,0.0544315423525971,0.511222165509667,0.0370165050571771,0.0432117293313704,0.0837651401761894,0.0325087360201092],[0.0328318424461325,0.174053799986102,0.0254652314606358,0.0885303576489657,0.0445113026889302,0.1429245583933,0.0224993153803608,0.0268676271679175,0.286367578724352,0.253825127012346],[0.022227346936255,0.050648641869155,0.208688456907399,0.243801243147736,0.416678019366762,0.0271737423519132,0.0203431430596731,0.0326754237107438,0.743402408374265,0.761033476754655],[0.0197012144749731,0.033850774309916,0.252269605535262,0.0518469366961029,0.0474480762867302,0.0234669315050739,0.0250330775596219,0.103051987050891,1,0.487802364338634],[0.0191866077780895,0.0637807266481489,0.143702319131842,0.525999058387031,0.0297107179735826,0.0216526763346725,0.0579505961377551,0.594529485497924,0.909524459731073,0.769930222262822],[0.0199715642252657,0.0463538597598987,0.399256391217546,0.0599789207280288,0.0280005623407078,0.0410036698791405,0.0695034936482979,0.551700876262218,0.456415265373237,0.555381130731952],[0.0224862798558067,0,0.0291497141197441,0.275781730053772,0.184337525306825,0.210293116911813,0.0896685640272992,0.291712634712726,0.789618209514351,0.294761058788633],[0.073455180862302,0.0210171762385607,0.0219144065656467,0.0293939072290554,0.0393326675937052,0.0242053396563775,0.0405444922938546,0.0811942088460088,0.553342374691692,0.61310247419348],[0.0189792091905765,0.0186802687839165,0.0267220674565517,0.0197531913692676,0.0169682181642072,0.0206175337193052,0.031355227386399,0.189461898638409,0.539209886606514,0.338578414264421]],"type":"surface","colorscale":[[0,1],["rgb(255,255,255)","rgb(85,100,94)"]],"colorbar":{"title":"CD3"},"inherit":true},"5ba29c05533.1":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"z":[[1.44160627828233,1.67445123044629,1.68371820074645,1.69752299745022,1.47526418560842,1.75569238064096,1.76467557420692,1.69285196084981,1.76347794901005,1.75416343915002],[1.6989827365944,1.62722065757413,1.68092806122703,1.63186736019234,1.6785632951022,1.20565133631176,1.83010031328123,1.89105076542183,2,1.78888401662997],[1.70057909559824,1.48943598831261,1.73189829273498,1.666466251068,1.71601573326202,1.56340361529885,1.61384500307044,1.7121354526712,1.57348612520917,1.01265782728395],[1.70341847640034,1.82141627662339,1.45987885126886,1.486412174017,1.38584596308882,1.58692394267728,1.53483747909733,1.70793357598519,1.04401548474204,1.0111902531061],[1.61320141064453,1.75030778109795,1.33821218117322,1.88356155094549,1.67900690792371,1.62421108333421,1.63750938470093,1.59276833239683,1.01346212672595,1.00991529803909],[1.6299426119237,1.77577412408589,1.42011328755419,1.03101167684567,1.70164527412716,1.58420013326208,1.71078203920679,1.39544798342261,1.00705694553804,1.01139204455555],[1.66787970844804,1.79681022752445,1.03487934629354,1.85092607647001,1.7311756701668,1.74744815953981,1.76649715207532,1.23172262481145,1.01223589970782,1.00953556322057],[1.36327964304927,1,1.80891954895942,1.25231269052667,1.40311663836236,1.37599774570124,1.8158624399708,1.49560667911353,1.00815726647188,1.01143040160793],[1.37274957309133,1.76765503201375,1.77587272268172,1.66882182831212,1.71583763758062,1.7350987333459,1.6841352797177,1.84434959864139,1.00928240667489,1.24243694819784],[1.71090355235261,1.68610893310534,1.79015260286386,1.63879835026318,1.65243062933009,1.61373681116727,1.63401650440035,1.59903167621278,1.01558006642234,1.33029897084832]],"type":"surface","colorscale":[[0,1],["rgb(255,255,255)","rgb(19,92,69)"]],"colorbar":{"title":"AMACR"},"inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"zaxis":{"title":[]}},"hovermode":"closest","showlegend":false,"legend":{"yanchor":"top","y":0.333333333333333}},"source":"A","config":{"showSendToCloud":false},"data":[{"colorbar":{"title":"CD3","ticklen":2,"len":0.333333333333333,"lenmode":"fraction","y":1,"yanchor":"top"},"colorscale":[[0,"rgb(255,255,255)"],[1,"rgb(85,100,94)"]],"showscale":true,"z":[[0.188884750788777,0.042538175501137,0.0639597550435166,0.0439940658366759,0.239365714219316,0.0369488839789383,0.0303714686585763,0.0720560345601629,0.0539545792762385,0.0296867777313727],[0.0405149022207013,0.0984779130858437,0.0328609841478996,0.0249033443946144,0.0544315423525971,0.511222165509667,0.0370165050571771,0.0432117293313704,0.0837651401761894,0.0325087360201092],[0.0328318424461325,0.174053799986102,0.0254652314606358,0.0885303576489657,0.0445113026889302,0.1429245583933,0.0224993153803608,0.0268676271679175,0.286367578724352,0.253825127012346],[0.022227346936255,0.050648641869155,0.208688456907399,0.243801243147736,0.416678019366762,0.0271737423519132,0.0203431430596731,0.0326754237107438,0.743402408374265,0.761033476754655],[0.0197012144749731,0.033850774309916,0.252269605535262,0.0518469366961029,0.0474480762867302,0.0234669315050739,0.0250330775596219,0.103051987050891,1,0.487802364338634],[0.0191866077780895,0.0637807266481489,0.143702319131842,0.525999058387031,0.0297107179735826,0.0216526763346725,0.0579505961377551,0.594529485497924,0.909524459731073,0.769930222262822],[0.0199715642252657,0.0463538597598987,0.399256391217546,0.0599789207280288,0.0280005623407078,0.0410036698791405,0.0695034936482979,0.551700876262218,0.456415265373237,0.555381130731952],[0.0224862798558067,0,0.0291497141197441,0.275781730053772,0.184337525306825,0.210293116911813,0.0896685640272992,0.291712634712726,0.789618209514351,0.294761058788633],[0.073455180862302,0.0210171762385607,0.0219144065656467,0.0293939072290554,0.0393326675937052,0.0242053396563775,0.0405444922938546,0.0811942088460088,0.553342374691692,0.61310247419348],[0.0189792091905765,0.0186802687839165,0.0267220674565517,0.0197531913692676,0.0169682181642072,0.0206175337193052,0.031355227386399,0.189461898638409,0.539209886606514,0.338578414264421]],"type":"surface","frame":null},{"colorbar":{"title":"AMACR","ticklen":2,"len":0.333333333333333,"lenmode":"fraction","y":0.666666666666667,"yanchor":"top"},"colorscale":[[0,"rgb(255,255,255)"],[1,"rgb(19,92,69)"]],"showscale":true,"z":[[1.44160627828233,1.67445123044629,1.68371820074645,1.69752299745022,1.47526418560842,1.75569238064096,1.76467557420692,1.69285196084981,1.76347794901005,1.75416343915002],[1.6989827365944,1.62722065757413,1.68092806122703,1.63186736019234,1.6785632951022,1.20565133631176,1.83010031328123,1.89105076542183,2,1.78888401662997],[1.70057909559824,1.48943598831261,1.73189829273498,1.666466251068,1.71601573326202,1.56340361529885,1.61384500307044,1.7121354526712,1.57348612520917,1.01265782728395],[1.70341847640034,1.82141627662339,1.45987885126886,1.486412174017,1.38584596308882,1.58692394267728,1.53483747909733,1.70793357598519,1.04401548474204,1.0111902531061],[1.61320141064453,1.75030778109795,1.33821218117322,1.88356155094549,1.67900690792371,1.62421108333421,1.63750938470093,1.59276833239683,1.01346212672595,1.00991529803909],[1.6299426119237,1.77577412408589,1.42011328755419,1.03101167684567,1.70164527412716,1.58420013326208,1.71078203920679,1.39544798342261,1.00705694553804,1.01139204455555],[1.66787970844804,1.79681022752445,1.03487934629354,1.85092607647001,1.7311756701668,1.74744815953981,1.76649715207532,1.23172262481145,1.01223589970782,1.00953556322057],[1.36327964304927,1,1.80891954895942,1.25231269052667,1.40311663836236,1.37599774570124,1.8158624399708,1.49560667911353,1.00815726647188,1.01143040160793],[1.37274957309133,1.76765503201375,1.77587272268172,1.66882182831212,1.71583763758062,1.7350987333459,1.6841352797177,1.84434959864139,1.00928240667489,1.24243694819784],[1.71090355235261,1.68610893310534,1.79015260286386,1.63879835026318,1.65243062933009,1.61373681116727,1.63401650440035,1.59903167621278,1.01558006642234,1.33029897084832]],"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script><p>Stacked surface plots of the AMACR (prostate cancer cell) and CD3 (T cell) markers in prostate tissue shows how AMACR and CD3 are mutually exclusive (valleys and mountains are opposite).</p>
</div>
</div>
<div id="identifying-gradients-of-cells" class="section level1">
<h1 class="hasAnchor">
<a href="#identifying-gradients-of-cells" class="anchor"></a>Identifying gradients of cells</h1>
<p>One of the main questions in the spatial analysis of cells in tissues is whether a particular cell type is close to or interacting with another, and this is used as a benchmark to compare groups of images (e.g. primary vs. metastatic). For example, in the study of recognition of tumour cells by the immune system, a main question is whether cytotoxic T cells are close to tumour cells, or whether PDL1+ cells are aggregated in the tumour area.</p>
<p>A common solution is the calculation of the average minimum distance of tumour cells to immune cells, or vice versa. In this case, the minimum distance between an immune cell and a tumour cell is calculated, and then the process is repeated for all immune cells. This result is then averaged, or the distributions are compared between images using a Wilcoxon test or similar. A major drawback of this naïve approach is that the total number of cells is not considered – even with no preferential attraction of immune cells to tumour cells, a large number of cells will result in smaller minimum distances, resulting in false positive results. In summary, these naïve metrics do not take into account the actual spatial distribution of cells.</p>
<p>In SPIAT we address this challenge using the concept of gradients. If there is a true aggregation or attraction of cell phenotype A to cell phenotype B, then we would see higher levels of marker A closer to cells of phenotype B, with this value decreasing the further we move away from cells of phenotype B. This concept of gradients also allows the identification of repulsion between cell types, such that if we see that marker A intensities are lower when close to cells of phenotype B, but increase as we move away, then we can say that there is likely to be a process of repulsion. This concept is implemented in SPIAT in the <code>plot_average_expression</code> function, with the <code>average_marker_expression_within_radius</code> being the helper function for the calculation of the marker level within a specified radius.</p>
<p><code>plot_average_expression</code> calculates the average intensity of the target_marker within a radius from the cells positive for the reference marker. Note that it pools all cells with the target marker that are within the specific radius of any reference cell. Results represent the average intensities within a radius, but do not correspond to metrics for each cell.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/average_marker_expression_within_radius.html">average_marker_expression_within_radius</a></span>(<span class="no">formatted_image</span>,
                                        <span class="kw">reference_marker</span> <span class="kw">=</span><span class="st">"CD8"</span>,
                                        <span class="kw">target_marker</span> <span class="kw">=</span> <span class="st">"CD4"</span>,
                                        <span class="kw">radius</span><span class="kw">=</span><span class="fl">30</span>)</pre></body></html></div>
<pre><code>## [1] 10.13677</code></pre>
<p><code>plot_average_expression</code> calculates the average expression of a target marker for a number of user-supplied radii values. It plots the expression level at each specified radius as a line graph.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_average_expression.html">plot_average_expression</a></span>(<span class="no">formatted_image</span>, <span class="kw">reference_marker</span><span class="kw">=</span><span class="st">"CD8"</span>, <span class="kw">target_marker</span><span class="kw">=</span><span class="st">"CD4"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">30</span>, <span class="fl">35</span>, <span class="fl">40</span>, <span class="fl">45</span>, <span class="fl">50</span>, <span class="fl">75</span>, <span class="fl">100</span>))</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>This plot shows that high levels of CD8 were observed in cells near CD4+ cells and these levels decreased at larger radii. This suggests CD4+ and CD8+ cells may be closely interacting in this tissue.</p>
</div>
<div id="calculating-distances-between-phenotypes" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-distances-between-phenotypes" class="anchor"></a>Calculating distances between phenotypes</h1>
<p>SPIAT implements a number of functions for the calculation of Euclidean distances between cells. First, we can compare the locations of two phenotypes (phenotype A and phenotype B) by identifying the closest cell of phenotype B to each of the cells of phenotype A with <code>calculate_all_distances_between_phenotypes</code>.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">distances</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/calculate_all_distances_between_phenotypes.html">calculate_all_distances_between_phenotypes</a></span>(<span class="no">formatted_image</span>, <span class="kw">remove_other</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">cell_phenotypes_of_interest</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span>))</pre></body></html></div>
<p>This creates a distribution of minimum distances between phenotypes A and B, which can be visualized as a violin plot with <code>plot_cell_distances_violin</code>. Visualization of this distribution often reveals whether pairs of cells are evenly spaced across the image, or whether there are clusters of pairs of phenotypes.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_cell_distances_violin.html">plot_cell_distances_violin</a></span>(<span class="no">distances</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-19-1.png" width="700"><img src="introduction_files/figure-html/unnamed-chunk-19-2.png" width="700"><img src="introduction_files/figure-html/unnamed-chunk-19-3.png" width="700"><img src="introduction_files/figure-html/unnamed-chunk-19-4.png" width="700"> From this plot we can see that CD3,CD4 cells seem to be more closely interacting with each other, as there are shorter distances between those cells, than between CD3,CD8 cells or between CD3,CD4 and CD3,CD8 cells.</p>
<p>We can also calculate summary statistics for the distances between each combination of phenotypes, the mean, median and standard deviation, with <code>calculate_summary_distances_between_phenotypes</code>.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">summary_distances</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/calculate_summary_distances_between_phenotypes.html">calculate_summary_distances_between_phenotypes</a></span>(<span class="no">formatted_image</span>)</pre></body></html></div>
<pre><code>## [1] "All markers are used in pair-wise distance calculation: "
## [1] "AMACR"   "CD3,CD4" "CD3,CD8" "PDL1"</code></pre>
<p>These cell distances can then be visualized as a heatmap with <code>plot_distance_heatmap</code>.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_distance_heatmap.html">plot_distance_heatmap</a></span>(<span class="no">summary_distances</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>This plot shows that AMACR cells are interacting most closely with CD3,CD4, followed by CD3,CD8, while PDL1 cells are more distant.</p>
</div>
<div id="measuring-association-to-cell-properties" class="section level1">
<h1 class="hasAnchor">
<a href="#measuring-association-to-cell-properties" class="anchor"></a>Measuring association to cell properties</h1>
<p>We can use <code>measure_association_to_cell_properties</code> to compare two phenotypes for a property. Method options are density plot, boxplot, t test or wilcoxon test.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="co"># boxplot</span>
<span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/measure_association_to_cell_properties.html">measure_association_to_cell_properties</a></span>(<span class="no">formatted_image</span>,
                                       <span class="kw">phenotypes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span>),
                                       <span class="kw">property</span> <span class="kw">=</span> <span class="st">"Cell.Size"</span>,
                                       <span class="kw">method</span> <span class="kw">=</span> <span class="st">"box"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="co"># t test</span>
<span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/measure_association_to_cell_properties.html">measure_association_to_cell_properties</a></span>(<span class="no">formatted_image</span>,
                                       <span class="kw">phenotypes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span>),
                                       <span class="kw">property</span> <span class="kw">=</span> <span class="st">"Cell.Size"</span>,
                                       <span class="kw">method</span> <span class="kw">=</span> <span class="st">"t"</span>)</pre></body></html></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  formatted_data[formatted_data$Phenotype == phenotypes[1], property] and formatted_data[formatted_data$Phenotype == phenotypes[2], property]
## t = 2.1766, df = 259.32, p-value = 0.03041
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##   2.783879 55.630562
## sample estimates:
## mean of x mean of y 
##  369.1637  339.9565</code></pre>
</div>
<div id="detecting-cell-clusters-and-communities" class="section level1">
<h1 class="hasAnchor">
<a href="#detecting-cell-clusters-and-communities" class="anchor"></a>Detecting cell clusters and communities</h1>
<p>One of the main recurrent quest ions in the analysis of the spatial distribution of cells in the microenvironment is the presence or absence of aggregates of a particular phenotype or combination of phenotype. In SPIAT, we make the distinction of two types of cell aggregates. The first are “clusters”, which are cell aggregates composed of non-tumour cells, often by immune cells. For the detection of clusters, <code>identify_cell_clusters</code> only considers cell phenotypes of interest defined by the user (e.g. clusters of CD3,CD4 and CD3,CD8 cells). Euclidean distances between cells are calculated, and pairs of cells with a distance less than a threshold are considered to be ‘interacting’, with the rest being ‘non-interacting’. Hierarchical clustering is then used to separate the clusters.</p>
<p>We need to specify a radius. The radius corresponds to how lenient we are in defining clusters. A bigger radius would mean we are more likely to merge individual clusters. The radius is chosen based on what looks ‘reasonable’.</p>
<p>Cells not assigned to clusters (“free” cells) are assigned to Cluster_NA in the output table.</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="no">clusters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/identify_cell_clusters.html">identify_cell_clusters</a></span>(<span class="no">formatted_image</span>, <span class="kw">phenotypes_of_interest</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD3,CD4"</span>, <span class="st">"CD3,CD8"</span>), <span class="kw">radius</span> <span class="kw">=</span> <span class="fl">100</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<p>This plot shows clusters of CD3+CD4+ and CD3+CD8+ cells. Each number and colour corresponds to a distinct cluster. Grey cells correspond to ‘free’, un-clustered cells.</p>
<p>While we recommend users to test out different thresholds and then visualise the clustering results, we also offer the <code>average_minimum_distance</code> function, which calculates the average minimum distance between all cells in an image to use as a reference or starting point.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/average_minimum_distance.html">average_minimum_distance</a></span>(<span class="no">formatted_image</span>)</pre></body></html></div>
<pre><code>## [1] 16.99093</code></pre>
<p>The second type of cell aggregates are “communities”, as previously defined <span class="citation">(Jackson et al. 2020)</span>. Here, communities correspond to micro-niches or micro-ecosystems of cells that are geographically located close to each other. The main distinction between clusters and communities is that the algorithm for the detection of communities used by <code>identify_cell_communities</code> does not take into account cell phenotype. Therefore, communities often consist of a combination of different cell types, including tumour cells. <em>dbscan</em> is used as the clustering algorithm to detect communities <span class="citation">(Hahsler, Piekenbrock, and Doran 2019)</span>. Cells without a phenotype are excluded.</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="no">communities</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/identify_cell_communities.html">identify_cell_communities</a></span>(<span class="no">formatted_image</span>, <span class="kw">radius</span><span class="kw">=</span><span class="fl">100</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>This plot shows communities of cells in the tissue. Each number and colour corresponds to a distinct community.</p>
<p>We can visualize the cell composition of clusters or communities. This allows discerning whether there are regions of heterotypic cell-cell interactions, or whether the image is highly structured with poor cell mixing.</p>
<p>To do this, we can use <code>composition_of_clusters_and_communities</code> to obtain the percentages of cells with a specific marker within each cluster and the number of cells in the cluster.</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">clusters_vis</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/composition_of_clusters_and_communities.html">composition_of_clusters_and_communities</a></span>(<span class="no">clusters</span>, <span class="st">"Cluster"</span>)
<span class="no">clusters_vis</span> <span class="kw">&lt;-</span> <span class="no">clusters_vis</span>[<span class="no">clusters_vis</span>$<span class="no">Total_number_of_cells</span> <span class="kw">&gt;=</span><span class="fl">5</span>,]</pre></body></html></div>
<p>The we can use <code>plot_composition_heatmap</code> to produce a heatmap showing the marker percentages within each cluster and the cluster sizes.</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_composition_heatmap.html">plot_composition_heatmap</a></span>(<span class="no">clusters_vis</span>, <span class="kw">column_to_consider</span><span class="kw">=</span><span class="st">"Cluster"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p>This plot shows that most clusters are composed of a mixture of CD3+CD4+ and CD3+CD8+ cells and some are more dominated by CD3+CD4+ than others.</p>
<p>We can visualise the composition of the communities in a similiar way.</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="no">communities_vis</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/composition_of_clusters_and_communities.html">composition_of_clusters_and_communities</a></span>(<span class="no">communities</span>, <span class="st">"Community"</span>)
<span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/plot_composition_heatmap.html">plot_composition_heatmap</a></span>(<span class="no">communities_vis</span>, <span class="kw">column_to_consider</span><span class="kw">=</span><span class="st">"Community"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<p>This plot shows that several communities detected have a combination of tumour (AMACR+) and immune cells while some are dominated by tumour or immune cells.</p>
</div>
<div id="calculating-cell-mixing" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-cell-mixing" class="anchor"></a>Calculating cell mixing</h1>
<p>SPIAT includes calculation of cell mixing scores, which was originally defined as the number of immune-tumor interactions divided by the number of immune-immune interactions <span class="citation">(Keren et al. 2018)</span>. We have generalized this score to allow calculation of any two cell phenotypes defined by the user. <code>compute_mixing_score</code> returns the mixing score between a reference marker and a target marker. The mixing score is defined by: the number of target-reference interactions/number of reference-reference interactions within a specified radius.</p>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/compute_mixing_score.html">compute_mixing_score</a></span>(<span class="no">formatted_image</span>, <span class="kw">reference_marker</span> <span class="kw">=</span> <span class="st">"CD4"</span>, <span class="kw">target_marker</span> <span class="kw">=</span> <span class="st">"CD8"</span>)</pre></body></html></div>
<pre><code>## [1] "Number of reference cells: 513"
## [1] "Number of target cells: 138"
## [1] "Number of reference-target interactions: 67"
## [1] "Number of reference-reference interactions: 412"</code></pre>
<pre><code>## [1] 0.1626214</code></pre>
</div>
<div id="identifying-bordering-cells" class="section level1">
<h1 class="hasAnchor">
<a href="#identifying-bordering-cells" class="anchor"></a>Identifying bordering cells</h1>
<p>A common question that arises in the study of the tumour microenvironment is whether immune cells are close to the tumour margin, or how does the density of a particular cell type differ between the tumour and stromal areas. A first step in answering this question is the identification of cells that separate two distinct tissue areas (e.g. tumour area vs. stromal area). This tissue segmentation process often relies on machine learning or manual delineation of the borders in HALO or InForm, which are either coarse and/or time- consuming, rely on user intervention and often result in poor resolution. In SPIAT we developed an algorithm <code>identify_bordering_cells</code> to automatically detect bordering cells, with only 5 parameters: reference_marker (reference area to be identified, i.e. tumour marker), noise_radius, radius, lower_bound and upper_bound. The algorithm is as follows:</p>
<ol style="list-style-type: decimal">
<li>We select reference_marker cells surrounded by other reference_marker cells: We first identify reference_marker cells with other reference_marker cells within noise_radius.<br>
</li>
<li>We select non-reference cells surrounded by other non-reference cells: Only keep non-reference cells with non-reference cells within noise_radius.<br>
</li>
<li>We identify bordering cells as those tumour cells surrounded by a certain percentage of stromal cells: We combine the cells identified in (1) and (2) and identify all neighbouring cells within radius. We then calculate the percentage of stromal cells in the neighbourhood of each tumour cell, and mark those tumour cells with a percentage of stromal cells within the lower_bound and upper_bound as bordering cells.</li>
</ol>
<p>The identified bordering cells can then be used as a reference for calculation of distances to other cell types. Note that while here we use tumour cells as an example for reference cell, the same can be applied to any cell type.</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/identify_bordering_cells.html">identify_bordering_cells</a></span>(<span class="no">formatted_image</span>, <span class="kw">reference_marker</span> <span class="kw">=</span> <span class="st">"AMACR"</span>,
                         <span class="kw">rm_noise_radius</span> <span class="kw">=</span> <span class="fl">50</span>, <span class="kw">radius</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">lower_bound</span> <span class="kw">=</span> <span class="fl">0.05</span>,
                         <span class="kw">upper_bound</span><span class="kw">=</span><span class="fl">0.7</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
</div>
<div id="calculating-neighbourhood-proportions" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-neighbourhood-proportions" class="anchor"></a>Calculating neighbourhood proportions</h1>
<p>SPIAT also offers an additional alternative to characterising cell aggregation, which is the calculation of the neighbourhood proportion with <code>percentage_of_cells_within_radius</code>. Here, we define the proportion of a target cell type within the neighbourhood of a reference cell type within a defined radius. This algorithm is inspired by previous work (8), but in that case the average proportion of all cells in an image was used. Here, we perform the calculation for each cell, and thus we take into account differences in spatial distribution. With our method, spatial structures can be identified by pinpointing cells with high neighbourhood proportions of the target cell type. Of note, <code>percentage_of_cells_within_radius</code> can be used for the detection of gradients instead of <code>average_marker_expression_within_radius</code>, however we recommend using the latter given its implementation allows a speedier analysis, and it does not depend on cell phenotyping as it uses marker intensities. The calculation is done per reference cell, so runtime will depend on the number of reference cells present.</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/percentage_of_cells_within_radius.html">percentage_of_cells_within_radius</a></span>(<span class="no">formatted_image</span>, <span class="kw">reference_phenotypes</span> <span class="kw">=</span> <span class="st">"PDL1"</span>, <span class="kw">target_phenotypes</span> <span class="kw">=</span> <span class="st">"AMACR"</span>, <span class="kw">radius</span><span class="kw">=</span><span class="fl">100</span>)</pre></body></html></div>
<pre><code>##  Cell_664 Cell_2760 Cell_2992 Cell_3147 
##  33.33333  94.73684   0.00000   0.00000</code></pre>
</div>
<div id="predicting-phenotypes" class="section level1">
<h1 class="hasAnchor">
<a href="#predicting-phenotypes" class="anchor"></a>Predicting phenotypes</h1>
<p>One of the main applications of InForm and HALO is for cell phenotyping. Here, the user selects ~10 cells that are visually ‘positive’ for a particular marker, which are then used as a training set to phenotype the rest to the cells. However, this is usually an iterative process, whereby the user often needs to recalibrate the model by further selecting more cells and so forth. As a result, cell phenotyping is often time-consuming. In SPIAT we have implemented algorithms for the automatic phenotyping of cells based on marker intensities <code>predict_phenotypes</code> that do not require user intervention or the manual setting of thresholds.</p>
<p>Conceptually, our base algorithm assumes that most cells in an image are not positive for the particular marker of interest. With this assumption, we can estimate the background levels of the marker based on the distribution of marker intensities. We have observed that in most cases, marker levels follow a Beta (or Beta-like) distribution skewed to the left with a long right tail. With the assumption that most cells are negative for the marker, cells in this right tail are marked as being positive. The cutoff is selected as the inflection point of the distribution as it flattens. We have also accounted for cases where there is a weak antibody signal, and the distribution might resemble a normal distribution, or where there is a bimodal distribution, and only cells after the second peak should be considered.</p>
<p><code>predict_phenotypes</code> produces a density plot showing actual and predicted cutoff of a positive reading for marker expression. It also prints to the console of the number of true positives (TP), true negatives (TN), false positives (FP) and false negatives (FN) under the prediction. It returns a dataframe containing the predicted expression status for a particular marker.</p>
<p>In cases where the cells to be phenotyped are likely to represent most of the cells in the image, for example tumour cells in a tumour-dense tissue, we have added an additional step to our base algorithm. Here, we first phenotype cells based on non-tumour markers (baseline_markers) (for example, immune markers). This population of cells is used to determine the distribution of background levels of the tumour marker. Subsequently, we select the 0.95 quantile of the tumour marker in this population as a putative threshold (threshold 1). We empirically determine the inflection point of the distribution of tumour markers using our base algorithm (threshold 2). Finally, we use whichever of the thresholds is greater as a cutoff for positive and negative cells.</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="no">predicted_image</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/predict_phenotypes.html">predict_phenotypes</a></span>(<span class="no">formatted_image</span>,
                                      <span class="kw">plot_actual_cutoff</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                      <span class="kw">plot_predicted_cutoff</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                      <span class="kw">thresholds</span> <span class="kw">=</span> <span class="kw">NULL</span>,
                                      <span class="kw">tumour_marker</span> <span class="kw">=</span> <span class="st">"AMACR"</span>,
                                      <span class="kw">baseline_markers</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD3"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>))</pre></body></html></div>
<pre><code>## [1] "For CD3:"
## [1] "TP:644 TN:4352 FP:98 FN:6"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-32-1.png" width="700"></p>
<pre><code>## [1] "For PDL1:"
## [1] "TP:2 TN:4884 FP:212 FN:2"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-32-2.png" width="700"></p>
<pre><code>## [1] "For CD4:"
## [1] "TP:449 TN:4423 FP:165 FN:63"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-32-3.png" width="700"></p>
<pre><code>## [1] "For CD8:"
## [1] "TP:138 TN:4705 FP:257 FN:0"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-32-4.png" width="700"></p>
<pre><code>## [1] "For AMACR:"
## [1] "TP:4413 TN:637 FP:17 FN:33"</code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-32-5.png" width="700"></p>
<p>We can use <code>marker_prediction_plot</code> to plot the predicted cell phenotypes and the ones obtained using HALO or InForm, for comparison. Of note, this algorithm does not take into account cell shape or size, so if these are required for phenotyping, manual phenotyping with HALO or InForm is encouraged.</p>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/SPIAT/man/marker_prediction_plot.html">marker_prediction_plot</a></span>(<span class="no">predicted_image</span>, <span class="kw">marker</span><span class="kw">=</span><span class="st">"CD3"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<p>The plot shows CD3+ cells in the tissue. On the left are the CD3+ cells defined by InForm and on the right are the CD3+ cells predicted using SPIAT.</p>
</div>
<div id="reproducibility" class="section level1">
<h1 class="hasAnchor">
<a href="#reproducibility" class="anchor"></a>Reproducibility</h1>
<div class="sourceCode" id="cb50"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span>()</pre></body></html></div>
<pre><code>## R version 4.0.2 Patched (2020-08-13 r79017)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-openmp/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] SPIAT_0.3                   SingleCellExperiment_1.11.6
##  [3] SummarizedExperiment_1.19.6 DelayedArray_0.15.7        
##  [5] matrixStats_0.56.0          Matrix_1.2-18              
##  [7] Biobase_2.49.0              GenomicRanges_1.41.6       
##  [9] GenomeInfoDb_1.25.10        IRanges_2.23.10            
## [11] S4Vectors_0.27.12           BiocGenerics_0.35.4        
## [13] BiocStyle_2.17.0           
## 
## loaded via a namespace (and not attached):
##  [1] httr_1.4.2             tidyr_1.1.1            jsonlite_1.7.0        
##  [4] viridisLite_0.3.0      gtools_3.8.2           assertthat_0.2.1      
##  [7] BiocManager_1.30.10    GenomeInfoDbData_1.2.3 yaml_2.2.1            
## [10] pillar_1.4.6           backports_1.1.8        lattice_0.20-41       
## [13] glue_1.4.1             digest_0.6.25          RColorBrewer_1.1-2    
## [16] XVector_0.29.3         colorspace_1.4-1       plyr_1.8.6            
## [19] htmltools_0.5.0        pkgconfig_2.0.3        pheatmap_1.0.12       
## [22] bookdown_0.20          zlibbioc_1.35.0        purrr_0.3.4           
## [25] scales_1.1.1           RANN_2.6.1             pracma_2.2.9          
## [28] tibble_3.0.3           farver_2.0.3           generics_0.0.2        
## [31] dbscan_1.1-5           ggplot2_3.3.2          ellipsis_0.3.1        
## [34] lazyeval_0.2.2         magrittr_1.5           crayon_1.3.4          
## [37] memoise_1.1.0          evaluate_0.14          apcluster_1.4.8       
## [40] fs_1.5.0               MASS_7.3-52            tools_4.0.2           
## [43] data.table_1.13.0      lifecycle_0.2.0        stringr_1.4.0         
## [46] plotly_4.9.2.1         munsell_0.5.0          compiler_4.0.2        
## [49] pkgdown_1.5.1          rlang_0.4.7            grid_4.0.2            
## [52] RCurl_1.98-1.2         htmlwidgets_1.5.1      crosstalk_1.1.0.1     
## [55] labeling_0.3           bitops_1.0-6           rmarkdown_2.3         
## [58] gtable_0.3.0           mmand_1.6.1            reshape2_1.4.4        
## [61] R6_2.4.1               gridExtra_2.3          knitr_1.29            
## [64] dplyr_1.0.2            rprojroot_1.3-2        desc_1.2.0            
## [67] stringi_1.4.6          Rcpp_1.0.5             vctrs_0.3.2           
## [70] tidyselect_1.1.0       xfun_0.16</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-hahsler2019dbscan">
<p>Hahsler, Michael, Matthew Piekenbrock, and Derek Doran. 2019. “Dbscan: Fast Density-Based Clustering with R.” <em>Journal of Statistical Software</em> 91 (1): 1–30.</p>
</div>
<div id="ref-jackson2020single">
<p>Jackson, Hartland W, Jana R Fischer, Vito RT Zanotelli, H Raza Ali, Robert Mechera, Savas D Soysal, Holger Moch, et al. 2020. “The Single-Cell Pathology Landscape of Breast Cancer.” <em>Nature</em> 578 (7796): 615–20.</p>
</div>
<div id="ref-keren2018structured">
<p>Keren, Leeat, Marc Bosse, Diana Marquez, Roshan Angoshtari, Samir Jain, Sushama Varma, Soo-Ryum Yang, et al. 2018. “A Structured Tumor-Immune Microenvironment in Triple Negative Breast Cancer Revealed by Multiplexed Ion Beam Imaging.” <em>Cell</em> 174 (6): 1373–87.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Anna Trigos, Tom  Yang, Yuzhou  Feng, Volkan  Ozcoban.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
